<!DOCTYPE html>
<html lang="id">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Toll Gate Karang Joang - #KonektivitasUntukNegeri</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css">
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Inter:wght@400;600;800&display=swap');
        
        body { 
            font-family: 'Inter', sans-serif; 
            background-color: #f8fafc;
            -webkit-tap-highlight-color: transparent;
        }

        .status-card {
            transition: all 0.4s cubic-bezier(0.4, 0, 0.2, 1);
        }

        .pulse-animation {
            animation: pulse 2s infinite;
        }

        @keyframes pulse {
            0% { transform: scale(1); opacity: 1; }
            50% { transform: scale(1.05); opacity: 0.8; }
            100% { transform: scale(1); opacity: 1; }
        }

        /* Status Colors */
        .bg-idle { background: linear-gradient(135deg, #223468 0%, #1a2a52 100%); }
        .bg-success { background: linear-gradient(135deg, #10b981 0%, #059669 100%); }
        .bg-error { background: linear-gradient(135deg, #ef4444 0%, #dc2626 100%); }
        .bg-emergency { background: linear-gradient(135deg, #f59e0b 0%, #d97706 100%); }

        /* Custom Scrollbar */
        ::-webkit-scrollbar { width: 4px; }
        ::-webkit-scrollbar-thumb { background: #cbd5e1; border-radius: 10px; }
    </style>
</head>
<body class="h-screen flex flex-col overflow-hidden">

    <!-- Top Navigation Bar -->
    <nav class="bg-white px-6 py-4 flex justify-between items-center shadow-sm border-b">
        <div>
            <h1 class="text-xl font-extrabold text-[#223468] tracking-tight">TOLL GATE</h1>
            <p class="text-[10px] text-gray-400 font-semibold tracking-widest uppercase">Karang Joang Portal</p>
        </div>
        <div class="text-right">
            <p id="liveClock" class="text-sm font-bold text-gray-700">00:00:00</p>
            <p id="liveDate" class="text-[10px] text-gray-400">01 Jan 2024</p>
        </div>
    </nav>

    <!-- Main Content Area -->
    <main class="flex-grow overflow-y-auto p-4 space-y-4 pb-32">
        
        <!-- Status Display Card -->
        <div id="statusCard" class="status-card bg-idle rounded-3xl p-8 text-center shadow-2xl relative overflow-hidden min-h-[300px] flex flex-col justify-center items-center">
            <div id="statusIcon" class="mb-6">
                <i class="fas fa-id-card text-6xl text-white/20"></i>
            </div>
            <h2 id="statusMessage" class="text-white text-3xl md:text-4xl font-black leading-tight">
                TAP KARTU<br><span class="text-white/60 text-xl font-medium">E-TOLL ANDA</span>
            </h2>
            <!-- Decorator Circles -->
            <div class="absolute -bottom-10 -right-10 w-32 h-32 bg-white/10 rounded-full"></div>
            <div class="absolute -top-10 -left-10 w-24 h-24 bg-white/5 rounded-full"></div>
        </div>

        <!-- Quick Stats -->
        <div class="grid grid-cols-2 gap-4">
            <div class="bg-white p-4 rounded-2xl shadow-sm border border-gray-100">
                <p class="text-gray-400 text-xs font-bold uppercase mb-1">Total Kendaraan</p>
                <p id="vehicleCounter" class="text-2xl font-black text-[#223468]">0</p>
            </div>
            <div class="bg-white p-4 rounded-2xl shadow-sm border border-gray-100">
                <p class="text-gray-400 text-xs font-bold uppercase mb-1">Status Gate</p>
                <p id="gateStatusText" class="text-sm font-bold text-green-500 flex items-center gap-1">
                    <span class="w-2 h-2 bg-green-500 rounded-full"></span> Ready
                </p>
            </div>
        </div>

        <!-- Recent Activity -->
        <div class="bg-white rounded-2xl shadow-sm border border-gray-100 overflow-hidden">
            <div class="p-4 border-b border-gray-50 flex justify-between items-center">
                <h3 class="font-bold text-gray-800 text-sm italic">Riwayat Terakhir</h3>
                <i class="fas fa-history text-gray-300"></i>
            </div>
            <div class="overflow-x-auto">
                <table class="w-full text-xs">
                    <tbody id="historyTable">
                        <!-- Data rows injected here -->
                    </tbody>
                </table>
            </div>
        </div>
    </main>

    <!-- Floating Action Buttons & Bottom Nav -->
    <div class="fixed bottom-0 left-0 right-0 bg-white/80 backdrop-blur-lg border-t border-gray-100 px-6 py-4 shadow-[0_-10px_20px_rgba(0,0,0,0.05)]">
        <div class="flex justify-between items-center gap-4">
            <button onclick="sendCommand('E')" class="flex flex-col items-center gap-1 group">
                <div class="w-12 h-12 bg-amber-100 text-amber-600 rounded-full flex items-center justify-center group-active:scale-90 transition">
                    <i class="fas fa-bolt"></i>
                </div>
                <span class="text-[10px] font-bold text-gray-500">Emergency</span>
            </button>
            
            <button onclick="sendCommand('R')" class="flex-grow bg-[#223468] text-white font-bold py-3 rounded-2xl shadow-lg shadow-blue-900/20 active:scale-95 transition">
                RESET SYSTEM
            </button>

            <button onclick="clearHistory()" class="flex flex-col items-center gap-1 group">
                <div class="w-12 h-12 bg-gray-100 text-gray-600 rounded-full flex items-center justify-center group-active:scale-90 transition">
                    <i class="fas fa-trash-alt"></i>
                </div>
                <span class="text-[10px] font-bold text-gray-500">Clear DB</span>
            </button>
        </div>
    </div>

    <script>
        const ws = new WebSocket(`ws://${window.location.host}/ws`);
        let resetTimer;

        function updateTime() {
            const now = new Date();
            document.getElementById('liveClock').innerText = now.toLocaleTimeString('id-ID', { hour12: false });
            document.getElementById('liveDate').innerText = now.toLocaleDateString('id-ID', { day: '2-digit', month: 'short', year: 'numeric' });
        }
        setInterval(updateTime, 1000);
        updateTime();

        ws.onmessage = (event) => {
            const data = JSON.parse(event.data);
            if (data.type === "status_update") {
                handleStatusChange(data.message);
            } else if (data.type === "init_data") {
                document.getElementById('vehicleCounter').innerText = data.count;
                updateTable(data.history);
            }
        };

        function handleStatusChange(msg) {
            const card = document.getElementById('statusCard');
            const icon = document.getElementById('statusIcon');
            const label = document.getElementById('statusMessage');
            
            clearTimeout(resetTimer);
            card.classList.remove('pulse-animation');

            if (msg.includes("Berhasil")) {
                card.className = "status-card bg-success rounded-3xl p-8 text-center shadow-2xl relative overflow-hidden min-h-[300px] flex flex-col justify-center items-center pulse-animation";
                icon.innerHTML = '<i class="fas fa-check-circle text-6xl text-white"></i>';
                label.innerHTML = `AKSES DITERIMA<br><span class="text-white/80 text-lg font-medium">Silahkan Lewat</span>`;
                refreshData();
            } else if (msg.includes("Gagal")) {
                card.className = "status-card bg-error rounded-3xl p-8 text-center shadow-2xl relative overflow-hidden min-h-[300px] flex flex-col justify-center items-center";
                icon.innerHTML = '<i class="fas fa-times-circle text-6xl text-white"></i>';
                label.innerHTML = `AKSES DITOLAK<br><span class="text-white/80 text-lg font-medium">Saldo Tidak Cukup</span>`;
            } else if (msg.includes("Emergency")) {
                card.className = "status-card bg-emergency rounded-3xl p-8 text-center shadow-2xl relative overflow-hidden min-h-[300px] flex flex-col justify-center items-center";
                icon.innerHTML = '<i class="fas fa-exclamation-triangle text-6xl text-white"></i>';
                label.innerHTML = `EMERGENCY MODE<br><span class="text-white/80 text-lg font-medium">Manual Override</span>`;
            }

            resetTimer = setTimeout(() => {
                card.className = "status-card bg-idle rounded-3xl p-8 text-center shadow-2xl relative overflow-hidden min-h-[300px] flex flex-col justify-center items-center";
                icon.innerHTML = '<i class="fas fa-id-card text-6xl text-white/20"></i>';
                label.innerHTML = `TAP KARTU<br><span class="text-white/60 text-xl font-medium">E-TOLL ANDA</span>`;
            }, 5000);
        }

        function updateTable(history) {
            const tableBody = document.getElementById('historyTable');
            tableBody.innerHTML = "";
            history.forEach(row => {
                const tr = document.createElement('tr');
                tr.className = "border-b border-gray-50 last:border-0";
                tr.innerHTML = `
                    <td class="p-4 font-semibold text-gray-500">${row.waktu.split(' ')[0]}</td>
                    <td class="p-4 text-right">
                        <span class="bg-blue-50 text-blue-700 px-2 py-1 rounded-md font-mono font-bold">${row.id_kartu}</span>
                    </td>
                `;
                tableBody.appendChild(tr);
            });
        }

        async function sendCommand(cmd) {
            await fetch(`/command/${cmd}`, { method: 'POST' });
        }

        async function refreshData() {
            const response = await fetch('/data');
            const data = await response.json();
            document.getElementById('vehicleCounter').innerText = data.count;
            updateTable(data.history);
        }

        async function clearHistory() {
            if (confirm("Hapus semua riwayat di database?")) {
                await fetch('/clear', { method: 'DELETE' });
                refreshData();
            }
        }
    </script>
</body>
</html>
